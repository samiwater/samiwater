<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>فرم ثبت درخواست | SamiWater</title>
  <style>
    :root{
      --green:#0f3d2e; --green-2:#134935; --gold:#d4af37; --text:#f7f7f7; --muted:#cfd8d3;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{
      font-family:Tahoma,Arial,sans-serif; margin:0; color:var(--text);
      background:radial-gradient(1200px 600px at 20% 0%, #114533, var(--green));
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:20px;
    }
    .card{
      width:100%; max-width:640px; background:linear-gradient(180deg,var(--green-2),var(--green));
      border:1px solid rgba(212,175,55,.25); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:22px;
    }
    .head{display:flex; align-items:center; gap:12px; margin-bottom:8px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(145deg,#1a5a43,#0c2a20);display:grid;place-items:center;border:1px solid rgba(212,175,55,.35);color:var(--gold);font-weight:700}
    .title{font-size:18px;font-weight:700}
    .sub{font-size:13px;color:var(--muted);margin-bottom:10px}
    label{display:block;font-size:13px;margin:10px 0 6px}
    input,textarea{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid #e6e6e6;
      font-size:15px; color:#222; background:#fff;
    }
    textarea{min-height:96px; resize:vertical}
    .btn{
      width:100%; margin-top:14px; padding:13px 12px; border-radius:12px;
      border:1px solid #b8942e; background:linear-gradient(180deg,#f1d36a,#d4af37);
      color:#2b2200; font-weight:700; font-size:16px;
    }
    .info{margin-top:6px; font-size:12px; color:#ffe79a}
    .msg{margin-top:10px; font-size:14px; color:#ffe79a}
  </style>
  <!-- تاریخ شمسی -->
  <script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.1.0/index.min.js"></script>
</head>
<body>
  <div class="card">
    <div class="head">
      <div class="logo">SA</div>
      <div>
        <div class="title">تکمیل مشخصات</div>
        <div class="sub">اگر قبلاً مشتری بوده‌اید و شناسایی نشدید، یک‌بار این فرم کوتاه را پر کنید.</div>
      </div>
    </div>

    <form id="requestForm">
      <label>شماره موبایل</label>
      <input id="phone" disabled />

      <label>نام و نام خانوادگی *</label>
      <input id="name" placeholder="مثلاً علی رضایی" required />

      <label>شهر *</label>
      <input id="city" placeholder="اصفهان" required />

      <label>آدرس دقیق *</label>
      <textarea id="address" placeholder="خیابان، کوچه، پلاک..." required></textarea>

      <label>شماره دوم (اختیاری)</label>
      <input id="altPhone" placeholder="تلفن ثابت یا همراه" />

      <label>تاریخ تولد (اختیاری) — شمسی</label>
      <input id="birthdateJalali" placeholder="مثلاً 1375/02/15" />

      <div id="serviceInfo" class="info"></div>

      <button class="btn" type="submit">ثبت نهایی</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>

<script>
  const API_BASE="https://samiwater-backend.onrender.com/api";

  const sourceToIssue={
    urgent:"درخواست فوری",
    maintenance:"سرویس دوره‌ای / تعویض فیلتر",
    repair:"تعمیر",
    install:"نصب",
    move:"اتصال/جابجایی",
    visit:"بازدید",
    other:"سایر",
    web_form:"سایر",
  };

  function getSource(){
    const p=new URLSearchParams(location.search);
    return (p.get("source")||sessionStorage.getItem("samiwater_type")||"web_form").toLowerCase();
  }

  const phoneStored=sessionStorage.getItem("samiwater_phone")||"";
  const sourcePath=getSource();
  const issueType=sourceToIssue[sourcePath]||sourceToIssue.other;
  document.getElementById("phone").value=phoneStored;
  document.getElementById("serviceInfo").textContent="نوع خدمت: "+issueType+" (تشخیص از مسیر)";

  // JALALI -> ISO
  function jalaliToGregorianISO(jalaliStr){
    if(!jalaliStr) return null;
    const m=/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/.exec(jalaliStr.trim());
    if(!m) return null;
    const jy=+m[1], jm=+m[2], jd=+m[3];
    const g=window.jalaali.toGregorian(jy,jm,jd);
    const mm=String(g.gm).padStart(2,"0"), dd=String(g.gd).padStart(2,"0");
    return `${g.gy}-${mm}-${dd}`;
  }

  document.getElementById("requestForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msg=document.getElementById("msg");

    const phone=phoneStored.trim();
    const fullName=document.getElementById("name").value.trim();
    const city=(document.getElementById("city").value||"اصفهان").trim();
    const address=document.getElementById("address").value.trim();
    const altPhone=document.getElementById("altPhone").value.trim();
    const birthJ=document.getElementById("birthdateJalali").value.trim();
    const birthISO=jalaliToGregorianISO(birthJ);

    if(!/^09\d{9}$/.test(phone)){ msg.textContent="❌ شماره معتبر نیست."; return; }
    if(!fullName||!city||!address){ msg.textContent="❌ فیلدهای ستاره‌دار را پر کنید."; return; }

    msg.textContent="در حال ارسال...";

    try{
      // 1) ساخت مشتری (409 اهمیتی ندارد)
      const cRes=await fetch(`${API_BASE}/customers`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({fullName,phone,address,altPhone,birthdate:birthISO||undefined,city})
      });
      if(!(cRes.ok||cRes.status===409)){
        const err=await cRes.json().catch(()=>({}));
        msg.textContent="❌ خطا در ثبت مشتری: "+(err.error||cRes.statusText); return;
      }

      // 2) ثبت درخواست
      const rRes=await fetch(`${API_BASE}/requests`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({phone,issueType,sourcePath})
      });
      if(!rRes.ok){
        const err=await rRes.json().catch(()=>({}));
        msg.textContent="❌ خطا در ثبت درخواست: "+(err.error||rRes.statusText); return;
      }

      const data=await rRes.json();
      sessionStorage.setItem("samiwater_invoice",data?.invoiceCode||"—");
      location.href="request-confirmed.html";
    }catch(e2){
      console.error(e2); msg.textContent="❌ ارتباط با سرور برقرار نشد.";
    }
  });
</script>
</body>
</html>
