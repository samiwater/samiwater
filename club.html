<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ورود | باشگاه مشتریان سامی</title>
  <style>
    body{margin:0;background:#0f3a2c;color:#fff;font-family:IRANSans, Vazirmatn, sans-serif}
    .wrap{max-width:520px;margin:40px auto;padding:24px;border:1px solid #1d5a46;border-radius:20px;background:linear-gradient(180deg,#0f3a2c,#0b2d23)}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .badge{width:44px;height:44px;border-radius:12px;background:linear-gradient(145deg,#113f31,#0a2b21);display:flex;align-items:center;justify-content:center;border:1px solid #2a6a52}
    .badge img{width:26px;height:26px;object-fit:contain}
    h1{margin:0;font-size:22px;color:#d4af37}
    label{display:block;margin:14px 0 6px}
    input{width:100%;padding:14px 12px;border-radius:12px;border:1px solid #2a6a52;background:#0c2f24;color:#fff;font-size:16px;outline:none}
    button{width:100%;margin-top:14px;padding:14px;border-radius:14px;border:none;background:#d4af37;color:#083427;font-weight:700;font-size:17px}
    .hint{margin-top:10px;color:#cbd5d1;font-size:13px}
    .pinWrap{display:none}
    .otpWrap{display:none}
    .gold{color:#d4af37}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="badge"><img src="logo-samiwater.png" alt="SA"></div>
      <h1>SamiWater | ورود</h1>
    </div>

    <label>شماره موبایل</label>
    <input id="phone" inputmode="numeric" placeholder="مثلاً 09131234567"/>

    <div class="pinWrap" id="pinWrap">
      <label>PIN اَدمین (فقط برای مدیر)</label>
      <input id="pin" inputmode="numeric" maxlength="6" placeholder="مثلاً 2468"/>
    </div>

    <button id="btnReq">ارسال کُد تأیید</button>

    <div class="otpWrap" id="otpWrap">
      <label>کُد تأیید</label>
      <input id="otp" inputmode="numeric" maxlength="6" placeholder="کد ۶ رقمی"/>
      <button id="btnVerify">تأیید و ورود</button>
      <div class="hint" id="devNote"></div>
    </div>

    <div class="hint">
      اگر با شماره مدیر وارد می‌شوید، <span class="gold">PIN</span> را هم وارد کنید. در حالت تست، کُد تأیید در پاسخ نمایش داده می‌شود.
    </div>
  </div>

<script>
const API = "https://samiwater-backend.onrender.com"; // آدرس بک‌اند خودت

const ADMIN_PHONE = "09384129843"; // فقط برای نمایش PIN field
const phoneEl = document.getElementById('phone');
const pinWrap = document.getElementById('pinWrap');
const pinEl = document.getElementById('pin');
const btnReq = document.getElementById('btnReq');
const otpWrap = document.getElementById('otpWrap');
const otpEl = document.getElementById('otp');
const btnVerify = document.getElementById('btnVerify');
const devNote = document.getElementById('devNote');

phoneEl.addEventListener('input', ()=>{
  const p = (phoneEl.value||"").trim();
  pinWrap.style.display = (p === ADMIN_PHONE) ? "block" : "none";
});

btnReq.onclick = async () => {
  const phone = (phoneEl.value||"").trim();
  if(!phone){ alert("شماره را وارد کنید"); return; }

  const payload = { phone };
  if(phone === ADMIN_PHONE){
    payload.pin = (pinEl.value||"").trim();
    if(!payload.pin){ alert("PIN ادمین را وارد کنید"); return; }
  }

  btnReq.disabled = true;
  try{
    const r = await fetch(API + "/api/auth/request-otp", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!r.ok){ throw new Error(data.error || "خطا"); }
    otpWrap.style.display = "block";
    devNote.textContent = data.devCode ? ("کُد برای تست: " + data.devCode) : "";
  }catch(e){
    alert(e.message);
  }finally{
    btnReq.disabled = false;
  }
};

btnVerify.onclick = async () => {
  const phone = (phoneEl.value||"").trim();
  const code = (otpEl.value||"").trim();
  if(!code){ alert("کُد را وارد کنید"); return; }
  btnVerify.disabled = true;
  try{
    const r = await fetch(API + "/api/auth/verify", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ phone, code })
    });
    const data = await r.json();
    if(!r.ok){ throw new Error(data.error || "خطا در تایید"); }
    localStorage.setItem("sami_token", data.token);
    localStorage.setItem("sami_role", data.role);
    location.href = "dashboard.html";
  }catch(e){
    alert(e.message);
  }finally{
    btnVerify.disabled = false;
  }
};
</script>
</body>
</html>
