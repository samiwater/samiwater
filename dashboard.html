<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>داشبورد | SamiWater</title>
  <style>
    :root{--green:#0f3b2e;--green2:#0b2e24;--gold:#d4af37;--gold2:#f1d26a}
    body{margin:0;background:linear-gradient(180deg,var(--green),var(--green2));color:#fff;
      font-family:Tahoma,Vazirmatn,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .logo{display:flex;gap:8px;align-items:center}
    .ico{width:36px;height:36px;border-radius:10px;border:1px solid rgba(212,175,55,.45);
      background:linear-gradient(145deg,#145,#0a3329);display:flex;align-items:center;justify-content:center;color:#f6e5a4;font-weight:800}
    .badge{background:rgba(212,175,55,.15);border:1px solid rgba(212,175,55,.35);padding:6px 10px;border-radius:12px}
    button{background:linear-gradient(180deg,var(--gold2),var(--gold));color:#112;border:none;border-radius:12px;padding:8px 12px}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(212,175,55,.35);border-radius:16px;padding:12px;margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(212,175,55,.15);padding:8px 6px;font-size:14px}
    th{color:#f1d26a;text-align:right}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    input,select{background:#0e2f25;color:#fff;border:1px solid rgba(212,175,55,.35);border-radius:10px;padding:8px 10px}
    .status{padding:4px 8px;border:1px solid rgba(212,175,55,.35);border-radius:10px;background:#0e2f25;color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <div class="ico">SA</div>
        <div>
          <div style="font-weight:700">SamiWater داشبورد</div>
          <div id="roleRow" class="badge">نقش: —</div>
        </div>
      </div>
      <div>
        <button id="logout">خروج</button>
      </div>
    </div>

    <div class="card">
      <div id="stats">در حال بارگذاری…</div>
    </div>

    <div class="card">
      <div style="margin-bottom:6px;color:#f1d26a">آخرین درخواست‌ها</div>

      <div class="filters">
        <input id="qPhone" placeholder="جستجو: موبایل" />
        <select id="qStatus">
          <option value="">همه وضعیت‌ها</option>
          <option value="pending">در انتظار</option>
          <option value="assigned">ارجاع‌شده</option>
          <option value="done">انجام‌شده</option>
          <option value="canceled">لغوشده</option>
        </select>
        <input id="qSource" placeholder="جستجو: مسیر" />
        <button id="applyFilters">اعمال فیلتر</button>
      </div>

      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>کد</th><th>موبایل</th><th>نوع</th><th>مسیر</th><th>زمان</th><th>وضعیت</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // ✅ این خط مهمه؛ اگر چیزی تو لاگین ذخیره شده از همان استفاده می‌کنیم
    const API_BASE = localStorage.getItem("sw_api") || "https://samiwater-backend.onrender.com";
    const role = localStorage.getItem("sw_role") || "user";
    const token = localStorage.getItem("sw_token") || "";

    document.getElementById("roleRow").textContent = `نقش: ${role === "admin" ? "مدیر" : "کاربر"}`;

    document.getElementById("logout").onclick = () => {
      localStorage.removeItem("sw_role");
      localStorage.removeItem("sw_phone");
      localStorage.removeItem("sw_token");
      location.href = "club-login.html";
    };

    const $ = (s) => document.querySelector(s);
    const tbody = document.querySelector("#tbl tbody");

    async function loadStats(){
      const r = await fetch(`${API_BASE}/api/admin/stats`);
      const j = await r.json();
      if(r.ok){
        $("#stats").textContent = `تعداد مشتریان: ${j.totalCustomers} | کل درخواست‌ها: ${j.totalRequests} | در انتظار: ${j.pendingCount}`;
      }else{
        $("#stats").textContent = "خطا در دریافت آمار";
      }
    }

    let allRows = [];
    async function loadRequests(){
      const r = await fetch(`${API_BASE}/api/admin/requests?limit=300`);
      const j = await r.json();
      if(!r.ok){ alert(j.error || "خطا در دریافت لیست"); return; }
      allRows = j;
      renderRows();
    }

    function renderRows(){
      const qPhone = $("#qPhone").value.trim();
      const qStatus = $("#qStatus").value;
      const qSource = $("#qSource").value.trim();

      const rows = allRows.filter(x =>
        (!qPhone  || (x.phone||"").includes(qPhone)) &&
        (!qStatus || x.status === qStatus) &&
        (!qSource || (x.sourcePath||"").includes(qSource))
      );

      tbody.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.invoiceCode}</td>
          <td><a href="${API_BASE}/api/customers/phone/${r.phone}" target="_blank" style="color:#f1d26a">${r.phone}</a></td>
          <td>${r.issueType || "-"}</td>
          <td>${r.sourcePath || "-"}</td>
          <td>${new Date(r.createdAt||r.created_at).toLocaleString("fa-IR")}</td>
          <td>
            ${
              role === "admin"
              ? `<select class="status" data-id="${r._id}">
                   <option value="pending"${r.status==="pending"?" selected":""}>در انتظار</option>
                   <option value="assigned"${r.status==="assigned"?" selected":""}>ارجاع‌شده</option>
                   <option value="done"${r.status==="done"?" selected":""}>انجام‌شده</option>
                   <option value="canceled"${r.status==="canceled"?" selected":""}>لغوشده</option>
                 </select>`
              : (r.status||"-")
            }
          </td>
        `;
        tbody.appendChild(tr);
      }

      // هندل تغییر وضعیت
      if(role === "admin"){
        document.querySelectorAll("select.status").forEach(sel=>{
          sel.onchange = async (e)=>{
            const id = sel.dataset.id;
            const status = sel.value;
            const resp = await fetch(`${API_BASE}/api/admin/requests/${id}/status`, {
              method:"PATCH", headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ status })
            });
            const j = await resp.json();
            if(!resp.ok){ alert(j.error||"خطا در تغییر وضعیت"); }
          };
        });
      }
    }

    $("#applyFilters").onclick = renderRows;

    // شروع
    loadStats();
    loadRequests();
  </script>
</body>
</html>
