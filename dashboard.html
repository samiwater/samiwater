<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>داشبورد | SamiWater</title>
  <style>
    body{margin:0;background:#0f3a2c;color:#fff;font-family:IRANSans, Vazirmatn, sans-serif}
    .container{max-width:980px;margin:30px auto;padding:0 16px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .badge{width:40px;height:40px;border-radius:10px;background:linear-gradient(145deg,#113f31,#0a2b21);display:flex;align-items:center;justify-content:center;border:1px solid #2a6a52}
    .badge img{width:24px;height:24px}
    h1{margin:0;font-size:20px;color:#d4af37}
    button{background:#d4af37;border:none;color:#083427;border-radius:10px;padding:10px 16px;font-weight:700}
    .card{border:1px solid #1d5a46;border-radius:16px;padding:16px;background:#0b2d23;margin-bottom:14px}
    .gold{color:#d4af37}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1d5a46;text-align:right}
    select{background:#0c2f24;color:#fff;border:1px solid #2a6a52;border-radius:8px;padding:6px}
  </style>
</head>
<body>
<div class="container">
  <div class="top">
    <div class="brand">
      <div class="badge"><img src="logo-samiwater.png" alt=""></div>
      <h1>داشبورد SamiWater</h1>
    </div>
    <div>
      <button onclick="logout()">خروج</button>
    </div>
  </div>

  <div id="roleLine" class="card"></div>
  <div id="body"></div>
</div>

<script>
const API = "https://samiwater-backend.onrender.com";

function token(){ return localStorage.getItem("sami_token"); }
function logout(){ localStorage.removeItem("sami_token"); localStorage.removeItem("sami_role"); location.href="club.html"; }

async function load(){
  const t = token();
  if(!t){ location.href="club.html"; return; }

  const r = await fetch(API + "/api/me", { headers: { "Authorization": "Bearer " + t }});
  const data = await r.json();
  if(!r.ok){ alert(data.error||"خطا"); logout(); return; }

  document.getElementById("roleLine").innerHTML =
    `نقش شما: <b class="gold">${data.role === 'admin' ? 'مدیر' : 'مشتری'}</b>`;

  const body = document.getElementById("body");
  if(data.role === "admin"){
    const s = data.stats;
    const rows = (data.lastRequests||[]).map(x => `
      <tr>
        <td>${x.invoiceCode}</td>
        <td>${x.phone}</td>
        <td>${x.issueType}</td>
        <td>${x.sourcePath||'-'}</td>
        <td>${new Date(x.createdAt).toLocaleString('fa-IR')}</td>
        <td>
          <select data-id="${x._id}" onchange="changeStatus(event)">
            ${["pending","assigned","done","canceled"].map(st => `<option value="${st}" ${st===x.status?'selected':''}>${st}</option>`).join("")}
          </select>
        </td>
      </tr>
    `).join("");

    body.innerHTML = `
      <div class="card">
        <div>تعداد مشتریان: <b class="gold">${s.totalCustomers}</b></div>
        <div>کل درخواست‌ها: <b class="gold">${s.totalRequests}</b> | در انتظار: <b class="gold">${s.pending}</b></div>
      </div>
      <div class="card">
        <h3>آخرین درخواست‌ها</h3>
        <table>
          <thead><tr><th>کد</th><th>موبایل</th><th>نوع</th><th>مسیر</th><th>زمان</th><th>وضعیت</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  } else {
    const c = data.customer || {};
    const rows = (data.myRequests||[]).map(x => `
      <tr>
        <td>${x.invoiceCode}</td>
        <td>${x.issueType}</td>
        <td>${x.sourcePath||'-'}</td>
        <td>${x.status}</td>
        <td>${new Date(x.createdAt).toLocaleString('fa-IR')}</td>
      </tr>
    `).join("");

    body.innerHTML = `
      <div class="card">
        <h3>اطلاعات شما</h3>
        <div>نام: <b class="gold">${c.fullName||'-'}</b></div>
        <div>موبایل: <b class="gold">${c.phone||'-'}</b></div>
        <div>شهر: <b class="gold">${c.city||'-'}</b></div>
        <div>آدرس: <b class="gold">${c.address||'-'}</b></div>
        <div>تولد: <b class="gold">${c.birthYear||'-'}/${c.birthMonth||'-'}/${c.birthDay||'-'}</b></div>
      </div>
      <div class="card">
        <h3>درخواست‌های شما</h3>
        <table>
          <thead><tr><th>کد</th><th>نوع</th><th>مسیر</th><th>وضعیت</th><th>زمان</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }
}

window.changeStatus = async (e) => {
  const id = e.target.getAttribute("data-id");
  const status = e.target.value;
  const r = await fetch(API + "/api/admin/requests/" + id, {
    method:"PATCH",
    headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token() },
    body: JSON.stringify({ status })
  });
  const data = await r.json();
  if(!r.ok){ alert(data.error||"خطا"); }
};

load();
</script>
</body>
</html>
