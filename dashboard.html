<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>داشبورد | SamiWater</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{background:#052e27;color:#eaf5f2;font-family:IRANSans, Vazirmatn, sans-serif}
    .wrap{max-width:1100px;margin:20px auto;padding:10px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .btn{background:#f3c842;color:#10352c;border:none;border-radius:12px;padding:10px 16px;font-weight:800}
    .card{border:1px solid #2f5c51;background:#0e4a3f;border-radius:18px;padding:16px;margin-top:14px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 8px}
    tr{background:#0b4036;border-radius:12px}
    .pill{padding:6px 10px;border-radius:20px;border:1px solid #2b5a50}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{max-width:560px;background:#0e4a3f;border:1px solid #2f5c51;border-radius:16px;padding:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .input, select{padding:10px 12px;border-radius:12px;border:1px solid #2f5c51;background:#f5faf9;color:#073128}
    .muted{opacity:.75}
    a.phone{color:#f3c842;text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="display:flex;gap:10px;align-items:center">
        <button id="logout" class="btn">خروج</button>
        <span class="pill">نقش: <b id="roleLbl">—</b></span>
      </div>
      <h2 style="color:#f3c842;margin:8px 0">SamiWater داشبورد</h2>
    </div>

    <div class="card" id="stats">در حال بارگذاری...</div>

    <div class="card">
      <h3 style="margin-top:0">آخرین درخواست‌ها</h3>

      <div class="grid2" style="margin-bottom:10px">
        <input id="qPhone" class="input" placeholder="فیلتر: موبایل" />
        <select id="qStatus" class="input">
          <option value="">همه وضعیت‌ها</option>
          <option value="pending">در انتظار</option>
          <option value="assigned">ارجاع شده</option>
          <option value="done">انجام شد</option>
          <option value="canceled">لغو شد</option>
        </select>
      </div>
      <input id="qSource" class="input" placeholder="جستجو: مسیر" />

      <button id="applyFilter" class="btn" style="margin-top:10px">اعمال فیلتر</button>

      <div style="overflow-x:auto;margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>کد</th>
              <th>موبایل</th>
              <th>نوع</th>
              <th>مسیر</th>
              <th>زمان</th>
              <th>وضعیت</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">برای دیدن اطلاعات مشتری روی شماره موبایل کلیک کنید.</div>
    </div>
  </div>

  <!-- Modal: اطلاعات مشتری -->
  <div id="modal" class="modal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:#f3c842">مشخصات مشتری</h3>
        <button id="closeModal" class="btn" style="background:#2e5e53;color:#fff">بستن</button>
      </div>
      <div id="cBody" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    const API = "https://samiwater-backend.onrender.com";
    const role = localStorage.getItem("sw_role") || "user";
    const phoneSelf = localStorage.getItem("sw_phone") || "";

    document.getElementById("roleLbl").textContent = (role === "admin" ? "مدیر" : "کاربر");
    document.getElementById("logout").onclick = () => {
      localStorage.removeItem("sw_role");
      localStorage.removeItem("sw_phone");
      location.href = "/club-login.html";
    };

    // برچسب فارسی وضعیت/مسیر
    const statusFa = { pending:"در انتظار", assigned:"ارجاع شده", done:"انجام شد", canceled:"لغو شد" };
    const sourceLabels = {
      "ems":"درخواست فوری",
      "web_form":"درخواست فوری",
      "services/maintenance":"خدمات › سرویس دوره‌ای",
      "services/install":"خدمات › نصب",
      "services/repair":"خدمات › تعمیر",
      "services/move":"خدمات › اتصال/جابجایی",
      "services/visit":"خدمات › بازدید",
      "services/other":"خدمات › سایر"
    };
    const fmtSource = v => sourceLabels[v] ?? (v ? v.replaceAll("/"," › ") : "—");

    function toJalali(ts){
      try{
        return new Intl.DateTimeFormat("fa-IR-u-ca-persian", {
          year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"
        }).format(new Date(ts));
      }catch{ return ts; }
    }

    async function apiGet(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("HTTP "+r.status);
      return r.json();
    }
    async function apiPatch(url, body){
      const r = await fetch(url, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data.error || ("HTTP "+r.status));
      return data;
    }

    // آمار + لیست
    let allRequests = [];
    async function loadAll(){
      const reqs = await apiGet(`${API}/api/requests`);
      allRequests = reqs;
      const customers = await apiGet(`${API}/api/customers`);
      document.getElementById("stats").innerHTML =
        `مشتریان: <b>${customers.length}</b> | کل درخواست‌ها: <b>${reqs.length}</b> | در انتظار: <b>${reqs.filter(r=>r.status==='pending').length}</b>`;
      renderRows();
    }

    function renderRows(){
      const qPhone = (document.getElementById("qPhone").value || "").trim();
      const qStatus= (document.getElementById("qStatus").value || "");
      const qSource= (document.getElementById("qSource").value || "").trim();

      let list = allRequests.slice().sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

      if(qPhone)  list = list.filter(r => (r.phone||"").includes(qPhone));
      if(qStatus) list = list.filter(r => (r.status||"")===qStatus);
      if(qSource) list = list.filter(r => fmtSource(r.sourcePath).includes(qSource));

      const rows = list.map(r => {
        const st = r.status || "pending";
        const stFa = statusFa[st] || st;
        const timeFa = toJalali(r.createdAt);
        const issue = r.issueType || "—";
        const sourceFa = fmtSource(r.sourcePath);

        // فقط مدیر اجازه تغییر وضعیت دارد
        const statusCell = (role === "admin")
          ? `<select data-id="${r._id}" class="input selStatus">
               <option value="pending"  ${st==='pending'?'selected':''}>در انتظار</option>
               <option value="assigned" ${st==='assigned'?'selected':''}>ارجاع شده</option>
               <option value="done"     ${st==='done'?'selected':''}>انجام شد</option>
               <option value="canceled" ${st==='canceled'?'selected':''}>لغو شد</option>
             </select>`
          : `<span class="pill">${stFa}</span>`;

        return `<tr>
          <td>${r.invoiceCode || "—"}</td>
          <td><a href="#" class="phone" data-phone="${r.phone}">${r.phone}</a></td>
          <td>${issue}</td>
          <td>${sourceFa}</td>
          <td>${timeFa}</td>
          <td>${statusCell}</td>
        </tr>`;
      }).join("");

      document.getElementById("rows").innerHTML = rows || `<tr><td colspan="6" class="muted">موردی یافت نشد.</td></tr>`;

      // رویدادهای تغییر وضعیت
      if(role === "admin"){
        document.querySelectorAll(".selStatus").forEach(sel=>{
          sel.addEventListener("change", async (e)=>{
            const id = sel.getAttribute("data-id");
            const value = sel.value;
            try{
              await apiPatch(`${API}/api/requests/${id}`, { status:value });
            }catch(err){
              alert("خطا در تغییر وضعیت: "+ err.message);
            }
          });
        });
      }

      // کلیک روی شماره برای دیدن مشتری
      document.querySelectorAll("a.phone").forEach(a=>{
        a.addEventListener("click", async (e)=>{
          e.preventDefault();
          const ph = a.getAttribute("data-phone");
          try{
            const c = await apiGet(`${API}/api/customers/phone/${encodeURIComponent(ph)}`);
            showCustomer(c);
          }catch(err){
            alert("مشتری یافت نشد");
          }
        });
      });
    }

    // مودال مشتری
    const modal = document.getElementById("modal");
    document.getElementById("closeModal").onclick = ()=> modal.style.display="none";

    function showCustomer(c){
      const body = `
        <div class="grid2">
          <div><div class="muted">نام</div><div style="font-weight:800">${c.fullName||"—"}</div></div>
          <div><div class="muted">موبایل</div><div style="font-weight:800">${c.phone||"—"}</div></div>
          <div><div class="muted">شهر</div><div>${c.city||"—"}</div></div>
          <div><div class="muted">تلفن دوم</div><div>${c.altPhone||"—"}</div></div>
          <div class="grid2" style="grid-column:1 / -1">
            <div><div class="muted">عضویت</div><div>${toJalali(c.joinedAt||c.createdAt||"")}</div></div>
            <div><div class="muted">تخفیف مشتری</div><div>${(c.discountPercent??0)}%</div></div>
          </div>
          <div style="grid-column:1 / -1"><div class="muted">آدرس</div><div>${c.address||"—"}</div></div>
        </div>`;
      document.getElementById("cBody").innerHTML = body;
      modal.style.display="flex";
    }

    document.getElementById("applyFilter").onclick = renderRows;

    // محدودیت دسترسی: اگر کاربر عادی است، فقط درخواست‌های مربوط به خودش را نشان بده
    async function init(){
      await loadAll();
      if(role !== "admin" && phoneSelf){
        allRequests = allRequests.filter(r => r.phone === phoneSelf);
        renderRows();
      }
    }
    init();
  </script>
</body>
</html>
